#include "FreeRTOS.h"
#include "task.h"
#include <libopencm3/stm32/rcc.h>
#include <libopencm3/stm32/gpio.h>

static void led_on_task(void *arg) {
    (void)arg;
    for (;;) {
        gpio_clear(GPIOC, GPIO13);   // LED on (PC13 active low)
        vTaskDelay(pdMS_TO_TICKS(250));
    }
}

static void led_off_task(void *arg) {
    (void)arg;
    for (;;) {
        gpio_set(GPIOC, GPIO13);     // LED off
        vTaskDelay(pdMS_TO_TICKS(250));
    }
}

int main(void) {
    rcc_periph_clock_enable(RCC_GPIOC);
    gpio_set_mode(GPIOC, GPIO_MODE_OUTPUT_2_MHZ,
                  GPIO_CNF_OUTPUT_PUSHPULL, GPIO13);

    xTaskCreate(led_on_task,  "on",  128, NULL, 1, NULL);
    xTaskCreate(led_off_task, "off", 128, NULL, 1, NULL);
    vTaskStartScheduler();
    for(;;);
}
